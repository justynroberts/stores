# .github/workflows/promote-to-production.yml
name: Promote Preproduction to Production

on:
  push:
    branches:
      - preproduction

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
      
      - name: Get Current Production SHA
        id: rollback
        run: |
          git fetch origin production
          ROLLBACK_SHA=$(git rev-parse origin/production)
          echo "sha=$ROLLBACK_SHA" >> $GITHUB_OUTPUT
          echo "Rollback point: $ROLLBACK_SHA"
      
      - name: Check for Existing PR
        id: check-pr
        run: |
          EXISTING_PR=$(gh pr list \
            --base production \
            --head preproduction \
            --state open \
            --json number \
            --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Found existing PR #$EXISTING_PR"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Pull Request
        id: create-pr
        if: steps.check-pr.outputs.found == 'false'
        run: |
          # Get changes summary
          CHANGES=$(git log origin/production..preproduction --oneline --max-count=10)
          FILES_CHANGED=$(git diff --stat origin/production...preproduction | tail -n1)
          JOBS_CHANGED=$(git diff --name-only origin/production...preproduction | grep -E '\.yaml$|\.yml$|\.xml$' || echo "No Rundeck jobs changed")
          
          # Create PR
          PR_URL=$(gh pr create \
            --base production \
            --head preproduction \
            --title "üöÄ Deploy to Production: $(date +'%Y-%m-%d %H:%M')" \
            --body "$(cat <<EOF
          ## Production Deployment Request
          
          **Build Number**: ${{ github.run_number }}
          **Triggered by**: ${{ github.actor }}
          **Commit**: ${{ github.sha }}
          
          ### ‚ö†Ô∏è Manual Review Required
          This PR requires manual approval before merging to production.
          
          ### Summary of Changes
          $FILES_CHANGED
          
          ### Recent Commits
          \`\`\`
          $CHANGES
          \`\`\`
          
          ### Rundeck Jobs Modified
          \`\`\`
          $JOBS_CHANGED
          \`\`\`
          
          ### Pre-Merge Checklist
          - [ ] Changes reviewed and tested in preproduction
          - [ ] No breaking changes identified
          - [ ] Rollback plan understood
          - [ ] Team notified of upcoming deployment
          
          ### Rollback Instructions
          If issues occur after merge, rollback to: \`${{ steps.rollback.outputs.sha }}\`
          
          \`\`\`bash
          # Quick rollback command:
          git checkout production
          git reset --hard ${{ steps.rollback.outputs.sha }}
          git push --force-with-lease origin production
          \`\`\`
          
          ### How to Deploy
          1. Review the changes above
          2. Ensure all checks pass
          3. Click "Merge pull request" when ready
          4. Monitor the deployment
          
          ---
          ‚è∞ **This PR will remain open until manually merged.**
          EOF
          )")
          
          # Extract PR number from URL
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '\d+$')
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER"
          echo "::notice title=PR Created::Pull Request #$PR_NUMBER created and awaiting review"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update Existing PR
        if: steps.check-pr.outputs.found == 'true'
        run: |
          # Add a comment to existing PR about new commits
          LATEST_COMMIT=$(git rev-parse --short HEAD)
          LATEST_MESSAGE=$(git log -1 --pretty=%B)
          
          gh pr comment ${{ steps.check-pr.outputs.number }} --body "$(cat <<EOF
          ## üìù Preproduction Updated
          
          **New commits pushed to preproduction**
          - Latest: \`$LATEST_COMMIT\`
          - Message: $LATEST_MESSAGE
          - Time: $(date +'%Y-%m-%d %H:%M:%S UTC')
          
          Please review the additional changes before merging.
          EOF
          )"
          echo "::notice title=PR Updated::Pull Request #${{ steps.check-pr.outputs.number }} updated with new commits"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set PR Number
        id: pr-number
        run: |
          if [ "${{ steps.check-pr.outputs.found }}" == "true" ]; then
            echo "number=${{ steps.check-pr.outputs.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ steps.create-pr.outputs.number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate Rundeck Jobs
        id: validate
        run: |
          echo "Validating Rundeck job files..."
          
          VALIDATION_PASSED=true
          VALIDATION_REPORT=""
          
          # Check YAML files
          for file in $(git diff --name-only origin/production...preproduction | grep -E '\.ya?ml$'); do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              if python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                VALIDATION_REPORT="${VALIDATION_REPORT}‚úÖ $file - Valid YAML\n"
              else
                VALIDATION_REPORT="${VALIDATION_REPORT}‚ùå $file - Invalid YAML\n"
                VALIDATION_PASSED=false
              fi
            fi
          done
          
          # Check XML files  
          for file in $(git diff --name-only origin/production...preproduction | grep '\.xml$'); do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              if python3 -c "import xml.etree.ElementTree as ET; ET.parse('$file')" 2>/dev/null; then
                VALIDATION_REPORT="${VALIDATION_REPORT}‚úÖ $file - Valid XML\n"
              else
                VALIDATION_REPORT="${VALIDATION_REPORT}‚ùå $file - Invalid XML\n"
                VALIDATION_PASSED=false
              fi
            fi
          done
          
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo -e "$VALIDATION_REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ "$VALIDATION_PASSED" == "true" ]; then
            echo "‚úÖ All validations passed"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Validation failed"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Comment Validation Results
        if: always()
        run: |
          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            STATUS_EMOJI="‚úÖ"
            STATUS_TEXT="All Checks Passed"
            READY_MESSAGE="This PR is ready for manual review and merge."
            LABEL="ready-for-review"
          else
            STATUS_EMOJI="‚ùå"
            STATUS_TEXT="Validation Failed"
            READY_MESSAGE="Please fix the validation errors before merging."
            LABEL="needs-fix"
          fi
          
          gh pr comment ${{ steps.pr-number.outputs.number }} --body "$(cat <<EOF
          ## $STATUS_EMOJI Validation Results: $STATUS_TEXT
          
          **Workflow Run**: [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          **Validated at**: $(date +'%Y-%m-%d %H:%M:%S UTC')
          
          ### File Validation Report
          ${{ steps.validate.outputs.report }}
          
          ### Next Steps
          $READY_MESSAGE
          
          EOF
          )"
          
          # Add label to PR
          gh pr edit ${{ steps.pr-number.outputs.number }} --add-label "$LABEL"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check-pr.outputs.found }}" == "true" ]; then
            echo "‚úÖ Updated existing PR #${{ steps.pr-number.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          else  
            echo "‚úÖ Created new PR #${{ steps.pr-number.outputs.number }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: Awaiting manual review and approval" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Pull Request](https://github.com/${{ github.repository }}/pull/${{ steps.pr-number.outputs.number }})" >> $GITHUB_STEP_SUMMARY
